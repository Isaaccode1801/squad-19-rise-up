<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Revisar Laudo</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f9fb;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    h1 {
      margin-bottom: 10px;
    }

    .dados-paciente {
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .dados-paciente p {
      margin: 4px 0;
    }

    .laudo-box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .laudo-box h2 {
      margin-top: 0;
      text-align: center;
    }

    .acoes {
      margin-top: 20px;
    }

    .acoes button {
      padding: 10px 15px;
      margin-right: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-voltar {
      background: #607d8b;
      color: white;
    }

    .btn-imprimir {
      background: #00bcd4;
      color: white;
    }

    .btn-liberar {
      background: #4caf50;
      color: white;
    }

    .btn-excluir {
      background: #f44336;
      color: white;
    }

    /* Cores do status */
    .status-verde {
      color: green;
      font-weight: bold;
    }

    .status-vermelho {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Revisão de Laudo</h1>

  <!-- Dados do paciente -->
  <div class="dados-paciente">
    <p><strong>Paciente:</strong> <span id="paciente"></span></p>
    <p><strong>Solicitante:</strong> <span id="solicitante"></span></p>
    <p><strong>Exame:</strong> <span id="exame"></span></p>
    <p><strong>Prazo:</strong> <span id="prazo"></span> - <span id="statusPrazo"></span></p>
  </div>

  <!-- Conteúdo do laudo -->
  <div class="laudo-box">
    <h2>RELATÓRIO MÉDICO</h2>
    <div id="conteudo"></div>
    <p id="assinatura"></p>
  </div>

  <!-- Ações -->
  <div class="acoes">
    <button class="btn-voltar" onclick="window.location.href='laudo.html'">
      <i class="fa fa-arrow-left"></i> Voltar
    </button>
    <button class="btn-imprimir" onclick="window.print()">
      <i class="fa fa-print"></i> Imprimir
    </button>
    <button class="btn-liberar" onclick="liberarLaudo()">
      <i class="fa fa-check"></i> Liberar
    </button>
    <button class="btn-excluir" onclick="excluirLaudo()">
      <i class="fa fa-trash"></i> Excluir
    </button>
  </div>

  <script>
    let laudoId = null;

    function formatarData(dataStr) {
      if (!dataStr) return "-";
      const data = new Date(dataStr);
      const dia = String(data.getDate()).padStart(2, '0');
      const mes = String(data.getMonth() + 1).padStart(2, '0');
      const ano = data.getFullYear();
      return `${dia}/${mes}/${ano}`;
    }

    function avaliarStatusPrazo(dataStr) {
      if (!dataStr) return "";
      const hoje = new Date();
      const prazo = new Date(dataStr + "T23:59:59");

      if (prazo >= hoje) {
        return '<span class="status-verde">Dentro do prazo</span>';
      } else {
        return '<span class="status-vermelho">Vencido</span>';
      }
    }

    window.onload = function () {
      const params = new URLSearchParams(window.location.search);
      laudoId = params.get("id");

      const laudos = JSON.parse(localStorage.getItem("laudos")) || [];
      const laudo = laudos.find((l) => l.id === laudoId);

      if (!laudo) {
        alert("Laudo não encontrado!");
        window.location.href = "laudo.html";
        return;
      }

      document.getElementById("paciente").innerText = laudo.paciente || "";
      document.getElementById("solicitante").innerText = laudo.solicitante || "";
      document.getElementById("exame").innerText = laudo.exame || "";

      const dataFormatada = formatarData(laudo.prazo);
      const status = avaliarStatusPrazo(laudo.prazo);

      document.getElementById("prazo").innerText = dataFormatada;
      document.getElementById("statusPrazo").innerHTML = status;

      document.getElementById("conteudo").innerHTML = laudo.conteudo || "";
      document.getElementById("assinatura").innerHTML = laudo.assinatura
        ? ""
        : "";
    };

    function liberarLaudo() {
      let laudos = JSON.parse(localStorage.getItem("laudos")) || [];
      const idx = laudos.findIndex((l) => l.id === laudoId);

      if (idx === -1) {
        alert("Erro ao liberar: laudo não encontrado.");
        return;
      }

      laudos[idx].status = "Liberado";
      localStorage.setItem("laudos", JSON.stringify(laudos));

      alert("Laudo liberado com sucesso!");
      window.location.href = "laudo.html";
    }

    function excluirLaudo() {
      if (!confirm("Tem certeza que deseja excluir este laudo? Essa ação não pode ser desfeita.")) return;

      let laudos = JSON.parse(localStorage.getItem("laudos")) || [];
      laudos = laudos.filter((l) => l.id !== laudoId);

      localStorage.setItem("laudos", JSON.stringify(laudos));
      alert("Laudo excluído com sucesso!");
      window.location.href = "laudo.html";
    }
  </script>
</body>
</html>