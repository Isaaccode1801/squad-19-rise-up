<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Histórico de Consultas • HealthOne</title>
  <!-- Importando a fonte e os ícones -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    /* ===== VARIÁVEIS DE DESIGN - TEMA CLARO COM EFEITO DE VIDRO ===== */
    :root {
      --cor-fundo: #F8F9FA;
      --cor-sidebar-vidro: rgba(255, 255, 255, 0.7);
      --cor-borda: rgba(0, 0, 0, 0.1);
      --cor-texto-principal: #212529;
      --cor-texto-secundario: #6C757D;
      --cor-acento-healthone: #3fbbc0;
      --cor-acento-healthone-claro: #e5f7f8;
      --raio-borda: 10px;
      --sombra: 0 4px 12px rgba(0, 0, 0, 0.05);
      --blur-fundo: 10px;
      --transicao: all 0.3s ease-in-out;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--cor-fundo);
      color: var(--cor-texto-principal);
      background-image: radial-gradient(circle at 5% 15%, rgba(63, 187, 192, 0.15), transparent 40%),
                        radial-gradient(circle at 95% 85%, rgba(63, 187, 192, 0.1), transparent 40%);
      min-height: 100vh;
    }

    /* ===== ESTILO DA SIDEBAR - EFEITO DE VIDRO ===== */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 260px;
      height: 100%;
      background-color: var(--cor-sidebar-vidro);
      backdrop-filter: blur(var(--blur-fundo));
      border-right: 1px solid var(--cor-borda);
      box-shadow: var(--sombra);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      padding: 20px 0;
      transition: var(--transicao);
    }
    .sidebar-header { display: flex; align-items: center; gap: 12px; padding: 0 25px 20px 25px; font-size: 22px; font-weight: 700; color: var(--cor-texto-principal); border-bottom: 1px solid var(--cor-borda); }
    .sidebar-header i { color: var(--cor-acento-healthone); }
    .nav-links { flex-grow: 1; margin-top: 20px; }
    .nav-links a { display: flex; align-items: center; gap: 15px; padding: 15px 25px; margin: 5px 15px; text-decoration: none; color: var(--cor-texto-secundario); font-size: 16px; font-weight: 500; border-radius: var(--raio-borda); position: relative; transition: var(--transicao); }
    .nav-links a i { width: 20px; text-align: center; }
    .nav-links a:hover { background: var(--cor-acento-healthone-claro); color: var(--cor-acento-healthone); }
    .nav-links a.active { background-color: var(--cor-acento-healthone-claro); color: var(--cor-acento-healthone); font-weight: 600; }
    .nav-links a.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); height: 60%; width: 4px; background-color: var(--cor-acento-healthone); border-radius: 0 4px 4px 0; }
    .sidebar-footer { padding: 10px 0; border-top: 1px solid var(--cor-borda); }

    /* ===== CONTEÚDO PRINCIPAL E LAYOUT CORRIGIDO ===== */
    .main-content {
      margin-left: 260px;
      padding: 20px;
      transition: var(--transicao);
    }

    /* ===== BOTÃO DE TOGGLE ===== */
    #toggle-sidebar-btn {
      position: fixed;
      top: 20px;
      left: 275px;
      z-index: 1001;
      background: var(--cor-sidebar-vidro);
      backdrop-filter: blur(var(--blur-fundo));
      border: 1px solid var(--cor-borda);
      color: var(--cor-acento-healthone);
      width: 40px; height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: grid;
      place-items: center;
      font-size: 18px;
      transition: var(--transicao);
      box-shadow: var(--sombra);
    }
    #toggle-sidebar-btn:hover { transform: scale(1.1); color: #fff; background-color: var(--cor-acento-healthone); }

    /* ===== ESTADO FECHADO ===== */
    body.sidebar-fechada .sidebar { left: -260px; }
    body.sidebar-fechada .main-content { margin-left: 0; }
    body.sidebar-fechada #toggle-sidebar-btn { left: 20px; }
    
    /* ===== ESTILOS DO SEU CONTEÚDO ORIGINAL (para evitar conflitos) ===== */
    .appbar{ background: var(--cor-sidebar-vidro); backdrop-filter: blur(var(--blur-fundo)); border-bottom: 1px solid var(--cor-borda); border-radius: var(--raio-borda); }
    .appbar-inner{ max-width:100%; padding:14px 20px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand h1{ margin:0; font-size:16px; }
    .brand small{ display:block; color:var(--cor-texto-secundario); font-size:12px; margin-top:2px; }
    main.wrap{ margin-top: 20px; }
    .toolbar{ display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:18px; align-items:center; }
    .card{ background: #fff; border-radius: var(--raio-borda); box-shadow: var(--sombra); }
    .card-header{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px 10px; border-bottom:1px solid var(--cor-borda); }
    .card-content{ padding:12px 18px 18px; }
    table{ width:100%; border-collapse:separate; border-spacing:0 10px; }
    thead.thead th{ text-align:left; font-size:12px; color:var(--cor-texto-secundario); padding:8px 12px; text-transform:uppercase; }
    tbody tr.row{ background:#fff; border-radius:var(--raio-borda); }
    tbody tr.row td{ padding:12px; vertical-align:middle; font-size:14px; }

    /* ===== Botão Nova Consulta ===== */
    .btn-nova-consulta{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:10px; border:1px solid var(--cor-borda);
      background: var(--cor-acento-healthone); color:#fff; cursor:pointer;
      font-weight:600; box-shadow: var(--sombra); transition: var(--transicao);
    }
    .btn-nova-consulta:hover{ filter:brightness(0.95); transform: translateY(-1px); }

    /* ===== Modal Nova Consulta (glass style) ===== */
    .modal-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.2); backdrop-filter: blur(2px);
      display:none; align-items:center; justify-content:center; z-index: 2000;
    }
    .modal-overlay.open{ display:flex; }
    .modal-card{
      width: min(720px, 92vw); background: rgba(255,255,255,.9);
      border:1px solid var(--cor-borda); border-radius: 12px; box-shadow: var(--sombra);
    }
    .modal-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px; border-bottom:1px solid var(--cor-borda);
    }
    .modal-head h3{ margin:0; font-size:18px; }
    .modal-body{ padding:16px; }
    .grid-2{ display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
    .grid-3{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-size:12px; color: var(--cor-texto-secundario); font-weight:600; }
    .field input, .field select, .field textarea{
      padding:10px 12px; border:1px solid var(--cor-borda); border-radius:8px; font: inherit; background:#fff;
    }
    .field textarea{ min-height: 72px; resize: vertical; }
    .modal-foot{
      padding:12px 16px; border-top:1px solid var(--cor-borda); display:flex; gap:10px; justify-content:flex-end;
    }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:8px; cursor:pointer; border:1px solid var(--cor-borda); background:#fff; }
    .btn.primary{ background: var(--cor-acento-healthone); color:#fff; border-color: transparent; }
    .btn.ghost{ background:#fff; color:var(--cor-texto-principal); }
  </style>
</head>
<body>

  <!-- ======================== HTML DA SIDEBAR ======================== -->
  <nav class="sidebar">
    <div class="sidebar-header">
      <i class="fa-solid fa-building"></i>
      <span>Medconnect</span>
    </div>
    <div class="nav-links">
      <a href="dash-secretaria.html"><i class="fa-solid fa-house"></i> Início</a>
      <a href="medicos.html"><i class="fa-solid fa-user-doctor"></i> Gerenciar Médicos</a>
      <a href="pacientes.html"><i class="fa-solid fa-users"></i> Gerenciar Pacientes</a>
      <a href="secretaria.html" class="active"><i class="fa-solid fa-calendar-check"></i> Gerenciar Consultas</a>
      <a href="laudo/Laudo.html"><i class="fa-solid fa-file-lines"></i> Relatórios</a>
      <a href="configuracoes.html"><i class="fa-solid fa-gear"></i> Configurações</a>
    </div>
    <div class="sidebar-footer">
      <a href="../../index.html"><i class="fa-solid fa-right-from-bracket"></i> Sair</a>
    </div>
  </nav>

  <!-- ================== BOTÃO E CONTEÚDO PRINCIPAL ================== -->
  <button id="toggle-sidebar-btn" title="Abrir/Fechar Menu">
    <i class="fa-solid fa-bars"></i>
  </button>

  <div class="main-content">
    <!-- Appbar (cabeçalho superior) -->
    <div class="appbar">
      <div class="appbar-inner">
        <div class="brand">
          <div>
            <h1>HealthOne</h1>
            <small>Histórico de Consultas</small>
          </div>
        </div>
        <div class="nav-links">
          <h1>Gerenciamento de Consultas</h1>
        </div>
      </div>
    </div>

    <!-- Conteúdo principal da página -->
    <main class="wrap">
      <div class="toolbar">
        <!-- ... seus filtros ... -->
      </div>
      <section class="card" aria-label="Histórico de consultas">
        <div class="card-header">
          <h2>Histórico de Consultas</h2>
          <button id="btn-open-new-appointment" class="btn-nova-consulta" type="button" title="Criar nova consulta">
            <i class="fa-solid fa-plus"></i> Nova Consulta
          </button>
        </div>
        <div class="card-content">
          <div class="table-wrap">
            <table id="Consultas">
              <thead class="thead">
                <tr>
                  <th>CPF</th><th>Paciente</th><th>Telefone</th><th>Médico</th><th>Data da Consulta</th><th>Ações</th>
                </tr>
              </thead>
              <tbody id="consultasBody"></tbody>
            </table>
          </div>
          <div class="empty note" id="note">Carregando consultas...</div>
        </div>
      </section>
    </main>
  </div>

  <!-- ======================== JAVASCRIPT ======================== -->
  <script type="module" src="../assets/js/consulta.js"></script>
  <script>
    // Injeta coluna "Ações" com botões Editar/Excluir e garante data-id nos botões
    (function () {
      const tbody = document.getElementById('consultasBody');
      if (!tbody) return;

      // tenta deduzir o ID da consulta a partir do <tr> ou de elementos internos
      function extractApptId(tr) {
        if (!tr) return '';
        return (
          tr.dataset.apptId ||
          tr.dataset.id ||
          tr.getAttribute('data-id') ||
          // busca por um elemento com data-appt-id em qualquer célula
          (tr.querySelector('[data-appt-id]')?.getAttribute('data-appt-id')) ||
          // busca por um elemento com data-id
          (tr.querySelector('[data-id]')?.getAttribute('data-id')) ||
          ''
        );
      }

      function buildActionsCell(apptId) {
        const td = document.createElement('td');
        td.innerHTML = `
          <button class="btn ghost js-edit-appointment" data-id="${apptId || ''}" title="${apptId ? 'Editar' : 'Sem ID para editar'}">
            <i class="fa-solid fa-pen"></i>
          </button>
          <button class="btn ghost js-delete-appointment" data-id="${apptId || ''}" title="${apptId ? 'Excluir' : 'Sem ID para excluir'}" style="margin-left:6px">
            <i class="fa-solid fa-trash"></i>
          </button>
        `;
        return td;
      }

      function ensureActions(tr) {
        if (!tr || tr.nodeType !== 1) return;

        // já tem botões?
        if (tr.querySelector('.js-edit-appointment, .js-delete-appointment')) {
          // garante que botões tenham data-id caso a linha tenha sido atualizada depois
          const apptId = extractApptId(tr);
          tr.querySelectorAll('.js-edit-appointment, .js-delete-appointment').forEach(btn => {
            if (!btn.dataset.id && apptId) btn.dataset.id = apptId;
          });
          return;
        }

        const apptId = extractApptId(tr);

        // tamanho esperado de colunas pelo THEAD
        const table = tr.closest('table');
        const expectedCols = table?.querySelectorAll('thead th')?.length || 6;
        const cells = tr.querySelectorAll('td');

        if (cells.length >= expectedCols) {
          const lastTd = cells[cells.length - 1];
          const actions = buildActionsCell(apptId);
          lastTd.innerHTML = '';
          while (actions.firstChild) lastTd.appendChild(actions.firstChild);
        } else {
          tr.appendChild(buildActionsCell(apptId));
        }
      }

      // processa linhas já existentes
      Array.from(tbody.querySelectorAll('tr')).forEach(ensureActions);

      // observa futuras inserções de linhas
      const observer = new MutationObserver((mutations) => {
        for (const m of mutations) {
          m.addedNodes.forEach((node) => {
            if (node.nodeType === 1 && node.tagName === 'TR') {
              ensureActions(node);
            } else if (node.nodeType === 1) {
              node.querySelectorAll && node.querySelectorAll('tr').forEach(ensureActions);
            }
          });
        }
      });
      observer.observe(tbody, { childList: true, subtree: true });

      // estilo para botões
      const style = document.createElement('style');
      style.textContent = `
        .btn.ghost { cursor: pointer; }
        .btn[disabled] { opacity:.45; cursor:not-allowed; }
      `;
      document.head.appendChild(style);
    })();
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const toggleBtn = document.getElementById('toggle-sidebar-btn');
      const body = document.body;
      const icon = toggleBtn.querySelector('i');

      if (toggleBtn && body && icon) {
        toggleBtn.addEventListener('click', () => {
          body.classList.toggle('sidebar-fechada');
          if (body.classList.contains('sidebar-fechada')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-xmark');
          } else {
            icon.classList.remove('fa-xmark');
            icon.classList.add('fa-bars');
          }
        });
      }
    });
  </script>

  <!-- ===== Modal: Nova Consulta ===== -->
  <div id="modal-nova-consulta" class="modal-overlay" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modal-nova-consulta-title">
      <div class="modal-head">
        <h3 id="modal-nova-consulta-title">Criar nova consulta</h3>
        <button type="button" class="btn ghost" id="btn-close-modal"><i class="fa-solid fa-xmark"></i> Fechar</button>
      </div>
      <form id="form-nova-consulta">
        <div class="modal-body">
          <div class="grid-2">
            <div class="field">
              <label for="nc-paciente">Paciente</label>
              <select id="nc-paciente" required>
                <option value="">Selecione…</option>
              </select>
            </div>
            <div class="field">
              <label for="nc-medico">Médico</label>
              <select id="nc-medico" required>
                <option value="">Selecione…</option>
              </select>
            </div>
          </div>

          <div class="grid-3" style="margin-top:12px;">
            <div class="field">
              <label for="nc-data">Data</label>
              <input type="date" id="nc-data" required/>
            </div>
            <div class="field">
              <label for="nc-hora">Hora</label>
              <input type="time" id="nc-hora" required/>
            </div>
            <div class="field">
              <label for="nc-duracao">Duração (min)</label>
              <input type="number" id="nc-duracao" min="10" step="5" value="30" required/>
            </div>
          </div>

          <div class="grid-2" style="margin-top:12px;">
            <div class="field">
              <label for="nc-tipo">Tipo</label>
              <select id="nc-tipo">
                <option value="presencial">Presencial</option>
                <option value="online">Online</option>
                <option value="domiciliar">Domiciliar</option>
              </select>
            </div>
            <div class="field">
              <label for="nc-convenio">Convênio</label>
              <input type="text" id="nc-convenio" placeholder="Ex.: Unimed"/>
            </div>
          </div>

          <div class="field" style="margin-top:12px;">
            <label for="nc-queixa">Queixa principal</label>
            <input type="text" id="nc-queixa" placeholder="Ex.: Dor de cabeça há 3 dias"/>
          </div>

          <div class="field" style="margin-top:12px;">
            <label for="nc-notas">Notas do paciente</label>
            <textarea id="nc-notas" placeholder="Preferências de horário, observações…"></textarea>
          </div>

          <div id="nc-feedback" style="margin-top:10px; font-size: 13px; color: #b45309;"></div>
        </div>
        <div class="modal-foot">
          <button type="button" class="btn ghost" id="btn-cancelar-nc">Cancelar</button>
          <button type="submit" class="btn primary" id="btn-salvar-nc"><i class="fa-solid fa-check"></i> Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { listPacientes, listarMedicos, getHeaders } from '../assets/js/pacientesService.js';

    const btnOpen = document.getElementById('btn-open-new-appointment');
    const modal    = document.getElementById('modal-nova-consulta');
    const btnClose = document.getElementById('btn-close-modal');
    const btnCancel= document.getElementById('btn-cancelar-nc');
    const form     = document.getElementById('form-nova-consulta');

    const selPaciente = document.getElementById('nc-paciente');
    const selMedico   = document.getElementById('nc-medico');
    const inpData     = document.getElementById('nc-data');
    const inpHora     = document.getElementById('nc-hora');
    const inpDuracao  = document.getElementById('nc-duracao');
    const selTipo     = document.getElementById('nc-tipo');
    const inpConvenio = document.getElementById('nc-convenio');
    const inpQueixa   = document.getElementById('nc-queixa');
    const inpNotas    = document.getElementById('nc-notas');
    const feedback    = document.getElementById('nc-feedback');
    const tbodyConsultas = document.getElementById('consultasBody');

    // ======== Disponibilidade de horários (Edge Function) ========
    const GET_SLOTS_ENDPOINT = 'https://yuanqfswhberkoevtmfr.supabase.co/functions/v1/get-available-slots';

    // cria um datalist para sugerir horários no input de hora
    const horaDatalistId = 'nc-horas-opcoes';
    let horaDatalist = document.getElementById(horaDatalistId);
    if (!horaDatalist) {
      horaDatalist = document.createElement('datalist');
      horaDatalist.id = horaDatalistId;
      document.body.appendChild(horaDatalist);
    }
    // vincula o datalist ao input de hora
    if (inpHora && !inpHora.getAttribute('list')) {
      inpHora.setAttribute('list', horaDatalistId);
    }

    // normaliza a resposta de slots para um array de "HH:MM" no horário local
    function normalizeSlots(respJson) {
      try {
        if (!respJson) return [];
        // Algumas funções retornam string JSON; tenta parsear se for string
        if (typeof respJson === 'string') {
          try { respJson = JSON.parse(respJson); } catch { /* mantém como está */ }
        }
        let arr = Array.isArray(respJson)
          ? respJson
          : respJson.slots || respJson.data || [];

        if (!Array.isArray(arr)) return [];

        return arr.map((s) => {
          if (s == null) return '';
          // aceita "09:00" (string) ou {time:"09:00"} ou {slot:"..."} comuns
          if (typeof s === 'object') {
            s = s.time || s.slot || s.start || s.value || '';
          }
          if (typeof s !== 'string') return '';
          if (/^\d{2}:\d{2}$/.test(s)) return s;

          // tenta ISO -> HH:mm local
          const d = new Date(s);
          if (!Number.isNaN(d.getTime())) {
            const hh = String(d.getHours()).padStart(2, '0');
            const mm = String(d.getMinutes()).padStart(2, '0');
            return `${hh}:${mm}`;
          }
          return '';
        }).filter(Boolean);
      } catch {
        return [];
      }
    }

    function fillHoraOptions(slotList) {
      // Limpa opções atuais
      horaDatalist.innerHTML = '';
      if (!slotList.length) {
        feedback.textContent = 'Nenhum horário disponível para esses filtros.';
        return;
      }
      feedback.textContent = '';
      slotList.forEach(hhmm => {
        const opt = document.createElement('option');
        opt.value = hhmm;
        horaDatalist.appendChild(opt);
      });
    }

    async function fetchAvailableSlots(doctorId, dateStr) {
      if (!doctorId || !dateStr) {
        fillHoraOptions([]);
        return;
      }

      const url = new URL(GET_SLOTS_ENDPOINT);
      url.searchParams.set('doctor_id', doctorId);
      url.searchParams.set('date', dateStr);

      try {
        const resp = await fetch(url.toString(), { headers: getHeaders() });

        if (!resp.ok) {
          // não tente parsear JSON se a função retornou erro/sem corpo
          const txt = await resp.text().catch(() => '');
          throw new Error(`(${resp.status}) ${txt || 'erro na função get-available-slots'}`);
        }

        // tenta detectar se há corpo JSON antes de parsear
        const ct = resp.headers.get('content-type') || '';
        let data;
        if (ct.includes('application/json')) {
          data = await resp.json();
        } else {
          // pode vir vazio; evita "Unexpected end of JSON input"
          const raw = await resp.text().catch(() => '');
          data = raw ? JSON.parse(raw) : { slots: [] };
        }

        const slots = normalizeSlots(data);
        fillHoraOptions(slots);
      } catch (e) {
        console.warn('[slots] falha ao buscar horários:', e?.message || e);
        fillHoraOptions([]);
        // mensagem amigável
        feedback.textContent = 'Não foi possível carregar horários disponíveis agora. Tente novamente mais tarde.';
      }
    }

    // dispara busca de horários quando médico ou data mudarem
    selMedico?.addEventListener('change', () => fetchAvailableSlots(selMedico.value, inpData.value));
    inpData?.addEventListener('change', () => fetchAvailableSlots(selMedico.value, inpData.value));

    function debounce(fn, ms = 250){
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
    }

    // substitui listeners por versões com debounce para evitar rajadas de chamadas
    selMedico?.addEventListener('change', debounce(() => fetchAvailableSlots(selMedico.value, inpData.value), 200));
    inpData?.addEventListener('change', debounce(() => fetchAvailableSlots(selMedico.value, inpData.value), 200));

    function setEditMode(id) {
      if (id) {
        form.dataset.editId = id;
        document.getElementById('modal-nova-consulta-title').textContent = 'Atualizar consulta';
        document.getElementById('btn-salvar-nc').innerHTML = '<i class="fa-solid fa-check"></i> Atualizar';
      } else {
        delete form.dataset.editId;
        document.getElementById('modal-nova-consulta-title').textContent = 'Criar nova consulta';
        document.getElementById('btn-salvar-nc').innerHTML = '<i class="fa-solid fa-check"></i> Salvar';
      }
    }

    // Endpoint mock da Apidog (evita CORS). Troque para Supabase quando estiver pronto.
    const APPOINTMENTS_ENDPOINT = 'https://yuanqfswhberkoevtmfr.supabase.co/rest/v1/appointments';

    // Helper: pega o ID do usuário logado (via Edge Function user-info)
    async function getCurrentUserId() {
      try {
        const url = 'https://yuanqfswhberkoevtmfr.supabase.co/functions/v1/user-info';
        const resp = await fetch(url, {
          method: 'GET',
          headers: getHeaders(), // inclui apikey + Authorization Bearer do localStorage
        });
        if (!resp.ok) {
          const txt = await resp.text().catch(() => '');
          throw new Error(`user-info falhou (${resp.status}) ${txt}`);
        }
        const info = await resp.json();
        return info?.user?.id || null;
      } catch (err) {
        console.warn('[nova-consulta] não foi possível obter user.id:', err?.message || err);
        return null;
      }
    }

    function openModal() {
      modal.classList.add('open');
      feedback.textContent = '';
      const isEdit = !!form.dataset.editId;
      if (!isEdit) {
        // Resetar todos os campos para "Nova consulta"
        selPaciente.value = '';
        selMedico.value   = '';
        inpDuracao.value  = '30';
        selTipo.value     = 'presencial';
        inpConvenio.value = '';
        inpQueixa.value   = '';
        inpNotas.value    = '';

        // Definir data/hora padrão: agora (local)
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm   = String(now.getMonth() + 1).padStart(2, '0');
        const dd   = String(now.getDate()).padStart(2, '0');
        const hh   = String(now.getHours()).padStart(2, '0');
        const mi   = String(now.getMinutes()).padStart(2, '0');

        inpData.value = `${yyyy}-${mm}-${dd}`;
        inpHora.value = `${hh}:${mi}`;
        // carrega sugestões de horários para o médico selecionado (se houver)
        fetchAvailableSlots(selMedico.value, inpData.value).catch(()=>{});
      }
    }
    function closeModal(){ modal.classList.remove('open'); }

    btnOpen?.addEventListener('click', async () => {
      setEditMode(null);
      openModal();
      // carrega selects
      try {
        // Pacientes
        selPaciente.innerHTML = '<option value="">Carregando…</option>';
        const pacientes = await listPacientes();
        selPaciente.innerHTML = '<option value="">Selecione…</option>';
        pacientes.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.full_name || p.email || p.cpf || p.id;
          selPaciente.appendChild(opt);
        });

        // Médicos
        selMedico.innerHTML = '<option value="">Carregando…</option>';
        const medicos = await listarMedicos();
        selMedico.innerHTML = '<option value="">Selecione…</option>';
        medicos.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = m.full_name || m.name || m.email || m.id;
          selMedico.appendChild(opt);
        });
      } catch (e) {
        console.error('[nova-consulta] erro ao carregar selects', e);
        feedback.textContent = 'Falha ao carregar pacientes/médicos. Tente novamente.';
      }
    });
    btnClose?.addEventListener('click', closeModal);
    btnCancel?.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

    function combineDateTimeToUTC(dateStr, timeStr){
      if(!dateStr || !timeStr) return null;
      const [y, m, d]   = dateStr.split('-').map(Number);
      const [hh, mm]    = timeStr.split(':').map(Number);
      // Cria a data em horário LOCAL e converte para ISO (UTC) automaticamente
      const dtLocal = new Date(y, (m || 1) - 1, d || 1, hh || 0, mm || 0, 0, 0);
      return dtLocal.toISOString();
    }

    async function fetchAppointmentById(id) {
      const url = `${APPOINTMENTS_ENDPOINT}?id=eq.${encodeURIComponent(id)}&select=*`;
      const resp = await fetch(url, { headers: getHeaders() });
      if (!resp.ok) {
        const txt = await resp.text().catch(() => '');
        throw new Error(`Falha ao obter consulta (${resp.status}) ${txt}`);
      }
      const arr = await resp.json();
      return arr[0] || null;
    }

    function splitDateTimeLocal(iso) {
      if (!iso) return { date: '', time: '' };
      const d = new Date(iso); // ISO (UTC) -> objeto Date
      // Extrai componentes em horário LOCAL
      const yyyy = d.getFullYear();
      const mm   = String(d.getMonth() + 1).padStart(2, '0');
      const dd   = String(d.getDate()).padStart(2, '0');
      const hh   = String(d.getHours()).padStart(2, '0');
      const mi   = String(d.getMinutes()).padStart(2, '0');
      return { date: `${yyyy}-${mm}-${dd}`, time: `${hh}:${mi}` };
    }

    tbodyConsultas?.addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;

      const tr = btn.closest('tr');
      const id =
        btn.dataset.id ||
        tr?.dataset?.apptId ||
        tr?.dataset?.id ||
        tr?.getAttribute('data-id') ||
        tr?.querySelector('[data-appt-id]')?.getAttribute('data-appt-id') ||
        tr?.querySelector('[data-id]')?.getAttribute('data-id') ||
        '';

      if (!id) {
        console.warn('[consultas] clique sem ID detectado nessa linha; verifique se o render das linhas inclui data-id.');
        return;
      }

      // DELETE
      if (btn.classList.contains('js-delete-appointment')) {
        if (!confirm('Tem certeza que deseja excluir esta consulta?')) return;
        try {
          const resp = await fetch(`${APPOINTMENTS_ENDPOINT}?id=eq.${encodeURIComponent(id)}`, {
            method: 'DELETE',
            headers: { ...getHeaders(), 'Prefer': 'return=minimal' }
          });
          if (!resp.ok && resp.status !== 204) {
            const txt = await resp.text().catch(() => '');
            throw new Error(`Falha ao excluir (${resp.status}) ${txt}`);
          }
          // remove a linha sem recarregar
          const row = btn.closest('tr');
          row?.parentNode?.removeChild(row);
        } catch (err) {
          alert(err.message || 'Erro ao excluir consulta.');
        }
        return;
      }

      // EDIT
      if (btn.classList.contains('js-edit-appointment')) {
        try {
          feedback.textContent = '';
          setEditMode(id);
          openModal();
          // garante selects carregados
          if (!selPaciente.options.length || selPaciente.options.length <= 1) {
            selPaciente.innerHTML = '<option value="">Carregando…</option>';
            const pacientes = await listPacientes();
            selPaciente.innerHTML = '<option value="">Selecione…</option>';
            pacientes.forEach(p => {
              const opt = new Option(p.full_name || p.email || p.cpf || p.id, p.id);
              selPaciente.add(opt);
            });
          }
          if (!selMedico.options.length || selMedico.options.length <= 1) {
            selMedico.innerHTML = '<option value="">Carregando…</option>';
            const medicos = await listarMedicos();
            selMedico.innerHTML = '<option value="">Selecione…</option>';
            medicos.forEach(m => {
              const opt = new Option(m.full_name || m.name || m.email || m.id, m.id);
              selMedico.add(opt);
            });
          }
          // Agora busca os dados e preenche os campos
          const appt = await fetchAppointmentById(id);
          if (!appt) throw new Error('Consulta não encontrada.');
          selPaciente.value = appt.patient_id || '';
          selMedico.value   = appt.doctor_id || '';
          const { date, time } = splitDateTimeLocal(appt.scheduled_at);
          inpData.value = date;
          inpHora.value = time;
          // atualiza as opções de horários levando em conta o médico e a data carregados
          fetchAvailableSlots(selMedico.value, inpData.value);
          inpDuracao.value = appt.duration_minutes || 30;
          selTipo.value = appt.appointment_type || 'presencial';
          inpConvenio.value = appt.insurance_provider || '';
          inpQueixa.value = appt.chief_complaint || '';
          inpNotas.value = appt.patient_notes || '';
        } catch (err) {
          alert(err.message || 'Erro ao carregar dados para edição.');
        }
      }
    });

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      feedback.style.color = '#b45309';
      feedback.textContent = 'Enviando…';

      // garante created_by exigido pelo banco
      const currentUserId = await getCurrentUserId();
      if (!currentUserId) {
        feedback.style.color = '#b91c1c';
        feedback.textContent = 'Sessão inválida: não foi possível identificar o usuário. Faça login novamente.';
        return;
      }

      const payload = {
        patient_id: selPaciente.value || null,
        doctor_id: selMedico.value || null,
        scheduled_at: combineDateTimeToUTC(inpData.value, inpHora.value),
        duration_minutes: Number(inpDuracao.value) || 30,
        appointment_type: selTipo.value || 'presencial',
        chief_complaint: inpQueixa.value || null,
        patient_notes: inpNotas.value || null,
        insurance_provider: inpConvenio.value || null,
        status: 'requested',
        created_by: currentUserId,
        updated_by: currentUserId
      };

      if (!payload.patient_id || !payload.doctor_id || !payload.scheduled_at) {
        feedback.style.color = '#b91c1c';
        feedback.textContent = 'Preencha paciente, médico, data e hora.';
        return;
      }
      // aviso útil caso esteja sem token no localStorage
      if (!localStorage.getItem('user_token')) {
        console.warn('[nova-consulta] sem user_token no localStorage');
      }

      try {
        // monta headers com apikey e bearer (vem do pacientesService)
        const headers = { ...getHeaders(), 'Prefer': 'return=representation' };
        const isEdit = !!form.dataset.editId;
        const url = isEdit
          ? `${APPOINTMENTS_ENDPOINT}?id=eq.${encodeURIComponent(form.dataset.editId)}`
          : APPOINTMENTS_ENDPOINT;
        const method = isEdit ? 'PATCH' : 'POST';

        const resp = await fetch(url, {
          method,
          headers,
          body: JSON.stringify(payload),
        });
        if (!resp.ok) {
          const txt = await resp.text().catch(() => '');
          throw new Error(`Falha ao ${isEdit ? 'atualizar' : 'criar'} consulta (${resp.status}). ${txt}`);
        }
        feedback.style.color = '#065f46';
        feedback.textContent = isEdit ? 'Consulta atualizada com sucesso!' : 'Consulta criada com sucesso!';
        setTimeout(() => {
          closeModal();
          // Atualiza a lista de consultas da página. Simples: recarregar.
          location.reload();
        }, 700);
      } catch (err) {
        console.error('[nova-consulta] erro no envio', err);
        feedback.style.color = '#b91c1c';
        feedback.textContent = err.message || 'Erro ao criar consulta.';
      }
    });
  </script>

</body>
</html>
