<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HealthOne ‚Äî Dashboard do Paciente</title>
<style>
  /* ====== TOKENS ====== */
  :root{
    --brand:#1db7ae; --brand-600:#12968f; --brand-100:#e7f7f6;
    --ink:#24323f; --muted:#6b7a88; --line:#e6eaef;
    --bg:#ffffff; --app:#f4f7fb; --radius:18px;
    --shadow:0 12px 28px rgba(18,150,143,.12);
    --soft:0 6px 18px rgba(36,50,63,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--app);color:var(--ink);
       font:14px/1.45 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

  /* ====== TOP NAV ====== */
  .topnav{
    position:sticky; top:0; z-index:10; background:var(--bg);
    border-bottom:1px solid var(--line); padding:12px 24px;
    display:flex; align-items:center; gap:22px;
  }
  .logo{display:flex; align-items:center; gap:10px; margin-right:8px}
  .logo-badge{width:36px;height:36px;border-radius:12px;
    background:linear-gradient(135deg,var(--brand),#64e4dc);
    display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:var(--soft)}
  .logo span{font-weight:800;color:var(--brand-600);letter-spacing:.3px}

  .tabs{display:flex; gap:16px; align-items:center; margin-left:auto}
  .tabs a{color:var(--muted); text-decoration:none; font-weight:600}
  .tabs a:hover{color:var(--brand-600)}
  .tabs .active{background:var(--brand); color:#fff; padding:8px 18px;
    border-radius:999px; box-shadow:0 4px 10px rgba(18,150,143,.25)}

  /* ====== LAYOUT ====== */
  .wrap{padding:24px; max-width:1300px; margin:0 auto}
  .grid{display:grid; grid-template-columns: 1fr 320px; gap:24px}
  .stack{display:grid; gap:18px; grid-template-columns:1fr 1fr}
  .card{background:var(--bg);border:1px solid var(--line);border-radius:var(--radius);
        box-shadow:var(--soft); padding:16px}
  .title{margin:0 0 10px 0; font-weight:800}

  /* Perfil */
  .profile{display:grid; grid-template-columns:64px 1fr; gap:14px; align-items:center}
  .avatar{width:64px;height:64px;border-radius:16px;background:#dbe7f1;
          display:grid;place-items:center;font-weight:800;color:#466;box-shadow:var(--soft)}
  .kv{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px}
  .kv div{display:flex;justify-content:space-between;background:#fafcff;border:1px solid var(--line);
          border-radius:10px;padding:8px 10px}

  /* An√©is */
  .circles{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
  .ring{display:grid;place-items:center;gap:8px}
  .meter{width:120px;height:120px;border-radius:50%;
    background:radial-gradient(closest-side,var(--bg) 60%,transparent 61% 100%),
              conic-gradient(#ff5c89 var(--p,75%),#ffe3ec 0);
    box-shadow:var(--soft)}
  .ring.blue .meter{
    background:radial-gradient(closest-side,var(--bg) 60%,transparent 61% 100%),
              conic-gradient(#2f68ff var(--p,83%),#dfe7ff 0)}
  .ring b{font-size:18px} .ring span{color:var(--muted);font-size:12px}

  /* Atividade (barras) */
  .bars{height:140px;display:flex;align-items:flex-end;gap:12px;padding:6px 8px}
  .bar{flex:1;border-radius:10px;background:linear-gradient(180deg,#ff9fb9,#ffd6e3);box-shadow:var(--soft)}
  .badge{background:var(--brand-100);color:var(--brand-600);padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}

  /* Linha (SVG) */
  .line-wrap{height:220px}
  .line-svg{width:100%;height:160px;display:block}
  .axis{stroke:#cfd7e3;stroke-width:1}
  .stroke-brand{fill:none;stroke:#4b82ff;stroke-width:3;stroke-linecap:round}

  /* Aside: calend√°rio + consultas */
  .calendar .grid{margin-top:10px;display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cell{aspect-ratio:1/1;display:grid;place-items:center;background:#fff;border:1px solid var(--line);border-radius:10px}
  .cell.h{background:transparent;border:0;color:var(--muted);font-weight:700}
  .cell.m{background:var(--brand-100);border-color:transparent;color:var(--brand-600);font-weight:700}
  .appt-list{display:flex;flex-direction:column;gap:10px}
  .appt{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;background:#fff;border:1px solid var(--line);box-shadow:var(--soft)}
  .appt .ic{width:32px;height:32px;border-radius:10px;display:grid;place-items:center;color:#fff;font-size:16px}
  .appt .time{margin-left:auto;font-weight:800;color:var(--muted)}
.brand{
    display:flex; align-items:center; gap:12px;
    }
        .logo{
      width:36px; height:36px; border-radius:10px;
      background: linear-gradient(135deg, var(--brand-primary), var(--brand-accent));
      box-shadow: 0 8px 20px rgba(37,99,235,.45), inset 0 0 10px rgba(255,255,255,.15);
    }
        .logo{
            margin-left: 150px;
    width:90px;
    height:auto;
  }
.ola{
    margin-left: 130px;
    grid-column: 1 / -1;
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom:4px;
  }
 .ola .greet{font-size:24px; font-weight:700;}

  .marca { display: flex; align-items: center; gap: .6rem; font-weight: 800; letter-spacing: .4px; }
  .marca .M { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--brand), #4dd7cf); display: grid; place-items: center; color: #fff; font-weight: 700; box-shadow: 0 6px 14px rgba(29,183,174,.35); }
  /* Responsivo */
  @media (max-width:1100px){ .grid{grid-template-columns:1fr} }
  @media (max-width:880px){ .stack{grid-template-columns:1fr} .tabs{gap:10px} }
          .logo-link img {
    height: 100px; /* Defina a altura da sua logo aqui */
    width: auto; /* Mant√©m a propor√ß√£o da imagem */
    display: block; /* Remove espa√ßos extras abaixo da imagem */
  }

 /* Bot√£o flutuante */
.acessibilidade-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background-color: var(--brand-600);
  color: white;
  border: none;
  border-radius: 50%;
  width: 65px;
  height: 65px;
  font-size: 28px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--shadow);
  transition: transform 0.2s, background-color 0.3s;
  z-index: 1000;
}

.acessibilidade-btn:hover {
  background-color: var(--brand);
  transform: scale(1.1);
}

/* Menu flutuante */
.menu-acessibilidade {
  position: fixed;
  bottom: 95px;
  right: 20px;
  background: #fff;
  border-radius: 16px;
  box-shadow: var(--shadow);
  padding: 15px;
  width: 230px;
  display: none;
  flex-direction: column;
  gap: 10px;
  z-index: 999;
  border: 1px solid var(--line);
}

.menu-acessibilidade h4 {
  margin: 0 0 10px 0;
  font-size: 15px;
  font-weight: 700;
  text-align: center;
  color: var(--ink);
  border-bottom: 1px solid var(--line);
  padding-bottom: 6px;
}

/* Itens */
.menu-item {
  background-color: #f7f9fb;
  border: 1px solid var(--line);
  border-radius: 10px;
  padding: 10px 12px;
  font-size: 14px;
  text-align: left;
  cursor: pointer;
  transition: background 0.2s, transform 0.15s;
  color: var(--ink);
  font-weight: 600;
}

.menu-item:hover {
  background-color: #eef3f7;
  transform: scale(1.03);
}

/* Controle de fonte */
#controlesFonte {
  display: none;
  justify-content: center;
  gap: 10px;
  margin-top: 8px;
}

#controlesFonte.visivel {
  display: flex;
}

.controle-fonte {
  background-color: #e6eaef;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  padding: 5px 10px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.controle-fonte:hover {
  background-color: #d4dae1;
}

/* ===============================
   üåô MODO ESCURO
=============================== */

body.modo-escuro {
  background-color: #111827;
  color: #e5e7eb;
}

body.modo-escuro .card {
  background-color: #1e293b;
  border-color: #2d3b4f;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.5);
}

body.modo-escuro .topnav {
  background-color: #1f2937;
  border-bottom-color: #2d3b4f;
}

body.modo-escuro .cell {
  background-color: #1e293b;
  border-color: #334155;
  color: #f3f4f6;
}

body.modo-escuro .tabs a {
  color: #cbd5e1;
}

body.modo-escuro .tabs a.active {
  background-color: var(--brand-600);
  color: #fff;
}

/* ====== Menu no modo escuro ====== */
body.modo-escuro .menu-acessibilidade {
  background-color: #1e293b !important;
  color: #f5f5f5 !important;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.6);
}

body.modo-escuro .menu-acessibilidade h4 {
  color: #f1f5f9 !important;
  border-bottom: 1px solid rgba(255, 255, 255, 0.15);
}

body.modo-escuro .menu-item {
  background-color: #273549 !important;
  color: #f8fafc !important;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

body.modo-escuro .menu-item:hover {
  background-color: #334155 !important;
}

body.modo-escuro .controle-fonte {
  background-color: #374151;
  color: #fff;
}

body.modo-escuro .controle-fonte:hover {
  background-color: #475569;
}

/* √çcone flutuante no modo escuro */
body.modo-escuro #btnAcessibilidade {
  background-color: var(--brand);
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
}

/* Suaviza transi√ß√µes */
body, body * {
  transition: background-color 0.25s ease, color 0.25s ease, box-shadow 0.25s ease;
}

/* ===============================
   üé® Modo Dalt√¥nico
=============================== */
.modo-daltonico {
  filter: hue-rotate(45deg) saturate(120%) !important;
}

body.modo-escuro .kv div,
body.modo-escuro .appt,
body.modo-escuro .cell:not(.h),
body.modo-escuro .bar {
  background-color: #1e293b !important;
  border-color: #334155 !important;
  color: #f3f4f6 !important;
}

/* √çcones das consultas */
body.modo-escuro .appt .ic {
  box-shadow: none;
  border: 1px solid rgba(255,255,255,0.1);
}

/* Linhas e eixos */
body.modo-escuro .axis {
  stroke: #475569;
}

body.modo-escuro .stroke-brand {
  stroke: #60a5fa;
}

/* Barras rosadas adaptadas ao tema escuro */
body.modo-escuro .bar {
  background: linear-gradient(180deg,#fb7185,#f9a8d4);
}

.consultas-container {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin-top: 10px;
}

.consultas-lista {
  display: flex;
  flex-direction: column;
  gap: 8px;
  width: 100%;
  max-width: 320px;
  overflow: hidden;
}

.consulta-card {
  background-color: var(--card, #1e2632);
  border-radius: 12px;
  padding: 10px 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: transform 0.3s ease;
}

.consulta-card:hover {
  transform: scale(1.02);
}

consultas-container {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  margin-top: 10px;
}
.nav-btn {
  background: var(--brand-600);
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 18px;
  cursor: pointer;
  padding: 6px 12px;
  transition: 0.2s;
}
.nav-btn:hover {
  background: var(--brand);
  transform: scale(1.1);
}
.nav-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

#appts {
  max-height: 280px; /* altura m√°xima vis√≠vel */
  overflow-y: auto;  /* cria rolagem vertical se passar do limite */
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding-right: 6px;
}

/* barras de rolagem mais discretas */
#appts::-webkit-scrollbar {
  width: 6px;
}
#appts::-webkit-scrollbar-thumb {
  background: var(--brand-500, #5aa9e6);
  border-radius: 6px;
}

</style>
</head>
<body>

<!-- ===== NAV SUPERIOR ===== -->
<header class="topnav">

      <div class="brand">
        <a href="../../index.html" class="logo-link">
          <img src="../assets/img/Medconnect.logo.png" alt="Logo HealthOne - P√°gina Principal">
        </a>
           
      <div class="marca">
        <div class="M">IK</div>
        <span>Isaac Kau√£</span>
      </div>
      </div>

  <!-- voc√™ pode colocar um campo de busca aqui se quiser -->
  <nav class="tabs">
    <a href="#" class="active">In√≠cio</a>
    <a href="agendamento.html" >Marcar Consulta</a>
  </nav>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

</header>
<div class="ola">
  <div class="greet">Ol√°, <span style="color:var(--brand-600)">Isaac Kau√£</span> üëã</div>
</div>
<!-- ===== CONTE√öDO ===== -->
<div class="wrap">
  <div class="grid">
    
    <!-- coluna principal -->
    <section class="stack">
      <article class="card">
        <h3 class="title">Perfil do Paciente</h3>
        <div class="profile">
          <div class="avatar">IK</div>
          <div>
            <strong>Isaac Kau√£</strong>
            <div style="color:var(--muted)">862.346.645-47</div>
          </div>
        </div>
        <div class="kv">
          <div><span>Idade</span><b>18 anos</b></div>
          <div><span>Tipo Sangu√≠neo</span><b>O+</b></div>
          <div><span>Altura</span><b>1,90 m</b></div>
          <div><span>Peso</span><b>100 kg</b></div>
        </div>
      </article>

      <article class="card">
        <h3 class="title">Indicadores</h3>
        <div class="circles">
          <div class="ring" style="--p:75%">
            <div class="meter" aria-label="Sa√∫de Geral 75%"></div>
            <b>75%</b><span>Sa√∫de Geral</span>
          </div>
          <div class="ring blue" style="--p:83%">
            <div class="meter" aria-label="Hidrata√ß√£o 83%"></div>
            <b>83%</b><span>Frequencia de Presen√ßa</span>
          </div>
        </div>
      </article>

      <article class="card">
        <h3 class="title">Taxa de Melhora</h3>
        <div class="bars">
          <div class="bar" style="height:40%"></div>
          <div class="bar" style="height:65%"></div>
          <div class="bar" style="height:55%"></div>
          <div class="bar" style="height:80%"></div>
          <div class="bar" style="height:50%"></div>
          <div class="bar" style="height:35%"></div>
          <div class="bar" style="height:60%"></div>
        </div>
        <div class="badge">Durante Tratamento</div>
      </article>

      <article class="card line-wrap">
        <h3 class="title">Condi√ß√µes de Sa√∫de</h3>
        <svg class="line-svg" viewBox="0 0 600 180" aria-label="Linha de tend√™ncia">
          <line x1="30" y1="150" x2="580" y2="150" class="axis"/>
          <line x1="30" y1="30"  x2="30"  y2="150" class="axis"/>
          <polyline class="stroke-brand"
            points="30,120 90,140 150,95 210,110 270,70 330,95 390,80 450,120 510,60 570,130"/>
        </svg>
        <small style="color:var(--muted)">Jan ‚Üí Dez</small>
      </article>
    </section>

    <!-- aside direito -->
    <aside>
      <div class="card calendar">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 class="title" style="margin:0">Consultas</h3>
          <span class="badge">Set 2025</span>
        </div>
        <div class="grid" id="cal"></div>
      </div>

      <div class="card">
  <h3 class="title">Pr√≥ximas Consultas</h3>
  <div class="appt-list" id="appts"></div>

  <!-- üîπ Colocar as setas aqui dentro -->
  <div class="consultas-container">
    <button id="prev" class="nav-btn">‚¨ÖÔ∏è</button>
    <button id="next" class="nav-btn">‚û°Ô∏è</button>
  </div>
</div>
        </div>
      </div>
    </aside>
  </div>
</div>

<button id="btnAcessibilidade" class="acessibilidade-btn" aria-label="Menu de acessibilidade">
  <i class="fa-solid fa-wheelchair"></i>
</button>
 <!-- Menu flutuante de acessibilidade -->
  <div id="menuAcessibilidade" class="menu-acessibilidade">
  <h4>Op√ß√µes de Acessibilidade</h4>
  <button class="menu-item" id="modoEscuro">üåì Fundo Preto</button>
   <div class="menu-item" id="aumentarFonteContainer">
    üî† Aumentar Fonte
    <div id="controlesFonte" class="controles-fonte">
      <button id="diminuirFonte" class="controle-fonte">‚ûñ</button>
      <span id="tamanhoFonteValor">100%</span>
      <button id="aumentarFonte" class="controle-fonte">‚ûï</button>
    </div>
  </div>
  <button class="menu-item" id="leitorTexto">üîä Leitor de Texto</button>
   <button class="menu-item" id="modoDaltonico">üé® Modo Dalt√¥nico</button>
</div>




<script>
  // mini calend√°rio (exemplo: mar√ßo com marca√ß√µes)
  (function(){
    const el = document.getElementById('cal');
    const heads = ['S','T','Q','Q','S','S','D'];
    heads.forEach(h=>{
      const c=document.createElement('div'); c.textContent=h; c.className='cell h'; el.appendChild(c);
    });
    const offset = 0; // domingo
    const blanks = (7 + offset) % 7;
    for(let i=0;i<blanks;i++){ const b=document.createElement('div'); b.className='cell'; b.style.visibility='hidden'; el.appendChild(b); }
    for(let d=1; d<=31; d++){
      const c=document.createElement('div'); c.className='cell'; c.textContent=d;
      if([3,10,17,24].includes(d)) c.classList.add('m');
      el.appendChild(c);
    }
  })();

 const btn = document.getElementById("btnAcessibilidade");
  const menu = document.getElementById("menuAcessibilidade");

  // Alternar visibilidade do menu
  btn.addEventListener("click", () => {
    menu.style.display = menu.style.display === "flex" ? "none" : "flex";
  });

  // Fechar se clicar fora
  document.addEventListener("click", (e) => {
    if (!menu.contains(e.target) && !btn.contains(e.target)) {
      menu.style.display = "none";
    }
  });

  // Fun√ß√µes de acessibilidade
  const corpo = document.body;

// Fun√ß√£o para salvar estado no localStorage
function salvarPreferencia(chave, valor) {
  localStorage.setItem(chave, JSON.stringify(valor));
}

// Fun√ß√£o para carregar estado salvo
function carregarPreferencia(chave) {
  const valor = localStorage.getItem(chave);
  return valor ? JSON.parse(valor) : false;
}

// ======== MODO ESCURO ========
const modoEscuroBtn = document.getElementById("modoEscuro");
let modoEscuroAtivo = carregarPreferencia("modoEscuro");

if (modoEscuroAtivo) document.body.classList.add("modo-escuro");

modoEscuroBtn.addEventListener("click", () => {
  modoEscuroAtivo = !modoEscuroAtivo;
  document.body.classList.toggle("modo-escuro", modoEscuroAtivo);
  salvarPreferencia("modoEscuro", modoEscuroAtivo);
});

// ======== MODO DALT√îNICO ========
const modoDaltonicoBtn = document.getElementById("modoDaltonico");
let modoDaltonicoAtivo = carregarPreferencia("modoDaltonico");

if (modoDaltonicoAtivo) document.body.classList.add("modo-daltonico");

modoDaltonicoBtn.addEventListener("click", () => {
  modoDaltonicoAtivo = !modoDaltonicoAtivo;
  document.body.classList.toggle("modo-daltonico", modoDaltonicoAtivo);
  salvarPreferencia("modoDaltonico", modoDaltonicoAtivo);
});

// ======== CONTROLE DE FONTE (ZOOM) ========

// Elementos
const aumentarFonteContainer = document.getElementById("aumentarFonteContainer");
const controlesFonte = document.getElementById("controlesFonte");
const btnMais = document.getElementById("aumentarFonte");
const btnMenos = document.getElementById("diminuirFonte");
const valorFonte = document.getElementById("tamanhoFonteValor");

// Estado inicial (carrega o √∫ltimo valor salvo)
let zoomPagina = carregarPreferencia("zoomPagina") || 100;

// Aplica o zoom salvo ao carregar
document.body.style.zoom = zoomPagina + "%";
if (valorFonte) valorFonte.textContent = `${zoomPagina}%`;

// Mostra/oculta os controles ao clicar no container
if (aumentarFonteContainer && controlesFonte) {
  aumentarFonteContainer.addEventListener("click", (e) => {
    e.stopPropagation();
    controlesFonte.classList.toggle("visivel");
  });
}

// Fun√ß√£o para aplicar o zoom e salvar
function aplicarZoom() {
  document.body.style.zoom = zoomPagina + "%";
  if (valorFonte) valorFonte.textContent = `${zoomPagina}%`;
  salvarPreferencia("zoomPagina", zoomPagina);
}

// Bot√£o ‚ûï
if (btnMais) {
  btnMais.addEventListener("click", (e) => {
    e.stopPropagation();
    if (zoomPagina < 180) {
      zoomPagina += 10;
      aplicarZoom();
    }
  });
}

// Bot√£o ‚ûñ
if (btnMenos) {
  btnMenos.addEventListener("click", (e) => {
    e.stopPropagation();
    if (zoomPagina > 80) {
      zoomPagina -= 10;
      aplicarZoom();
    }
  });
}

// ======== LEITOR DE TEXTO ========
let leitorAtivo = carregarPreferencia("leitorTexto");

document.getElementById("leitorTexto").addEventListener("click", () => {
  leitorAtivo = !leitorAtivo;
  salvarPreferencia("leitorTexto", leitorAtivo);
  alert(leitorAtivo ? "Leitor de texto ativado." : "Leitor de texto desativado.");
});

document.addEventListener("mouseover", (e) => {
  if (leitorAtivo && e.target.textContent.trim().length > 0) {
    const texto = e.target.textContent.trim();
    const fala = new SpeechSynthesisUtterance(texto);
    fala.lang = "pt-BR";
    speechSynthesis.cancel();
    speechSynthesis.speak(fala);
  }
});

// === üî• DASHBOARD DO PACIENTE: LISTAR AGENDAMENTOS REAIS ===

// === üß† CONFIGURA√á√ÉO ===
const SUPABASE_BASE = "https://yuanqfswhberkoevtmfr.supabase.co";
const API_BASE = `${SUPABASE_BASE}/rest/v1`;
const API_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1YW5xZnN3aGJlcmtvZXZ0bWZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NTQzNjksImV4cCI6MjA3MDUzMDM2OX0.g8Fm4XAvtX46zifBZnYVH4tVuQkqUH6Ia9CXQj4DztQ";

const API_AGENDAMENTOS =
  `${API_BASE}/appointments`; 
const PATIENT_ID = "3854866a-5476-48be-8313-77029ccdd7a7";

// === üîê 1Ô∏è‚É£ AUTENTICA√á√ÉO SUPABASE / APIDOG ===
async function login() {
  const existing = sessionStorage.getItem("token");
  if (existing) return existing; // j√° autenticado

  try {
    const res = await fetch(
      `${SUPABASE_BASE}/auth/v1/token?grant_type=password`,
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: API_KEY,
        },
        body: JSON.stringify({
          email: "riseup@popcode.com.br",
          password: "riseup",
        }),
      }
    );

    if (!res.ok) throw new Error(`Falha no login: ${res.status}`);
    const data = await res.json();

    const token = data.access_token;
    sessionStorage.setItem("token", token);
    console.log("‚úÖ Login bem-sucedido, token salvo!");
    return token;
  } catch (err) {
    console.error("‚ùå Erro ao autenticar:", err);
    alert("Erro ao autenticar. Verifique as credenciais da API.");
  }
}

// Fun√ß√£o auxiliar para montar headers com apikey + bearer
function getHeaders(extra = {}) {
  // üí° DEBUG: Tenta ler o token do armazenamento
  const token = sessionStorage.getItem("token"); 
  //console.log("DEBUG: Token lido de sessionStorage:", token ? "Sim" : "N√£o"); 
  
  const headers = Object.assign(
    {
      "Content-Type": "application/json",
      apikey: API_KEY,
      // üí° Se o token existir, adiciona o Bearer
      ...(token && { Authorization: `Bearer ${token}` }), 
    },
    extra
  );
  
  // üí° DEBUG: Mostra o valor do Header de Autoriza√ß√£o que ser√° enviado
  //console.log("DEBUG: Header Authorization:", headers.Authorization); 
  
  return headers;
}

// === 2Ô∏è‚É£ BUSCAR M√âDICOS (com token) ===
async function listarMedicosSupabase() {
  try {
    await login(); // garante que est√° autenticado

    const resp = await fetch(`${API_BASE}/doctors`, {
      method: "GET",
      headers: getHeaders(),
    });
    if (!resp.ok) throw new Error(`Erro ao buscar m√©dicos: ${resp.status}`);
    const medicos = await resp.json();

    // Monta mapa: doctor_id ‚Üí { nome, especialidade }
    const mapa = {};
    medicos.forEach((m) => {
      mapa[m.id] = {
        nome: m.full_name || "Sem Nome",
        especialidade: m.specialty || "Cl√≠nico Geral",
      };
    });
    return mapa;
  } catch (err) {
    console.error("‚ùå Erro ao carregar m√©dicos:", err);
    return {};
  }
}

// === 3Ô∏è‚É£ BUSCAR E EXIBIR CONSULTAS DO PACIENTE (com pagina√ß√£o de 4) ===
let paginaAtual = 0;
const LIMITE_POR_PAGINA = 4;
let agendamentosGlobais = [];

async function listarAgendamentosPaciente() {
  const lista = document.getElementById("appts");
  lista.innerHTML = "<p style='color:var(--muted)'>Carregando consultas...</p>";

  try {
    const token = await login();
    console.log("DEBUG: Token obtido:", token ? "sim" : "n√£o");

    // üîπ Busca todas as consultas do paciente
   const url = `${API_AGENDAMENTOS}?select=*&order=scheduled_at.desc`;
    const resp = await fetch(url, {
      method: "GET",
      headers: getHeaders(),
    });

    if (!resp.ok) throw new Error(`Erro ${resp.status}`);
    const agendamentos = await resp.json();
    console.log("‚úÖ Agendamentos recebidos:", agendamentos);

    if (!agendamentos.length) {
      lista.innerHTML = "<p style='color:var(--muted)'>Nenhuma consulta encontrada.</p>";
      return;
    }

    // Salva os agendamentos para pagina√ß√£o
    agendamentosGlobais = agendamentos;
    paginaAtual = 0;

    // Busca os m√©dicos para exibir nomes
    const medicos = await listarMedicosSupabase();
    renderizarConsultas(medicos);
  } catch (err) {
    console.error("‚ùå Erro ao carregar agendamentos:", err);
    lista.innerHTML = `<p style='color:red'>Erro ao carregar consultas: ${err.message}</p>`;
  }
}

function renderizarConsultas(medicos) {
  const lista = document.getElementById("appts");
  lista.innerHTML = "";

  const inicio = paginaAtual * LIMITE_POR_PAGINA;
  const fim = inicio + LIMITE_POR_PAGINA;
  const pagina = agendamentosGlobais.slice(inicio, fim);

  pagina.forEach(a => {
    const medico = medicos[a.doctor_id] || { nome: "M√©dico Desconhecido", especialidade: "‚Äî" };
    const data = new Date(a.scheduled_at);
    const dataFormatada = data.toLocaleDateString("pt-BR", {
      day: "2-digit", month: "short", year: "numeric",
    });
    const hora = data.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });

    const card = `
      <div class="appt">
        <div class="ic" style="background-color: var(--brand-600);">
          <i class="fa-solid fa-user-md"></i>
        </div>
        <div>
          <strong>${medico.nome}</strong><br>
          <span style="color:var(--muted); font-size:13px;">${medico.especialidade}</span><br>
          <span style="font-size:13px;">${dataFormatada} √†s ${hora}</span>
        </div>
        <div class="time">${a.status || "Agendado"}</div>
      </div>`;
    lista.insertAdjacentHTML("beforeend", card);
  });

  // üîπ Controles de navega√ß√£o (setas)
  const controles = `
    <div style="display:flex;justify-content:center;align-items:center;gap:10px;margin-top:10px;">
      <span style="color:var(--muted);font-size:13px;">
        P√°gina ${paginaAtual + 1} de ${Math.ceil(agendamentosGlobais.length / LIMITE_POR_PAGINA)}
      </span>
    </div>
  `;
  lista.insertAdjacentHTML("beforeend", controles);

  // Eventos das setas
  document.getElementById("prev").onclick = async () => {
    if (paginaAtual > 0) {
      paginaAtual--;
      renderizarConsultas(medicos);
    }
  };
  document.getElementById("next").onclick = async () => {
    if ((paginaAtual + 1) * LIMITE_POR_PAGINA < agendamentosGlobais.length) {
      paginaAtual++;
      renderizarConsultas(medicos);
    }
  };
}

// === 4Ô∏è‚É£ INICIALIZA√á√ÉO AUTOM√ÅTICA ===
(async function init() {
  await login(); // autentica antes de tudo
  listarAgendamentosPaciente();
})();

</script>
</body>
</html>
